<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Chuan|Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #00d2ff; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'PingFang SC', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: rgba(255,255,255,0.05); padding: 2.5rem; border-radius: 20px; width: 380px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        h2 { text-align: center; letter-spacing: 3px; color: var(--primary); margin-bottom: 2rem; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group i { position: absolute; left: 12px; top: 15px; color: #555; }
        input { width: 100%; padding: 12px 12px 12px 35px; background: #111; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(0, 210, 255, 0.2); }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-top: 15px; transition: 0.3s; }
        .btn-reg { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
        .btn-reg:hover { background: rgba(0, 210, 255, 0.1); }
        .btn-login { background: var(--primary); color: #000; }
        .btn-login:hover { filter: brightness(1.1); }
        #msg { font-size: 0.8rem; margin-top: 15px; text-align: center; min-height: 1.2em; color: #ff4d4d; }
    </style>
</head>
<body>
    <div class="card">
        <h2>LAB LOGIN</h2>
        
        <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="username" placeholder="用户名">
        </div>
        
        <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="password" placeholder="密码">
        </div>

        <div class="input-group">
            <i class="fas fa-key"></i>
            <input type="password" id="adminCheck" placeholder="管理员秘钥 (选填)">
        </div>

        <div id="msg"></div>
        
        <button class="btn-login" onclick="handleLogin()">登 录</button>
        <button class="btn-reg" onclick="handleSignUp()">新用户注册</button>
    </div>

    <script>
        const SB_URL = 'https://bwbmnaobukcjatwevcqm.supabase.co';
        const SB_KEY = 'sb_publishable_2Pt8kRnWJCI17rA7CGgjyA_lsIhFE4T';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        // 提示信息美化
        function showMsg(m, isSuccess = false) {
            const el = document.getElementById('msg');
            el.innerText = m;
            el.style.color = isSuccess ? "#00ff88" : "#ff4d4d";
        }

        async function handleSignUp() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            
            if(!user || !pass) return showMsg("请填写用户名和密码");

            // 注册一律设为普通用户
            const { data: exist } = await _supabase.from('profiles').select('*').eq('username', user).maybeSingle();
            if(exist) return showMsg("用户名已存在");

            const { error } = await _supabase.from('profiles').insert([
                { username: user, password: pass, role: 'user' }
            ]);

            if(!error) showMsg("注册成功！请直接登录", true);
            else showMsg("错误：" + error.message);
        }

        async function handleLogin() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const inputSecret = document.getElementById('adminCheck').value.trim();

            if(!user || !pass) return showMsg("请填写完整信息");

            // 1. 验证基础账号密码
            const { data, error } = await _supabase.from('profiles')
                .select('*')
                .eq('username', user)
                .eq('password', pass)
                .maybeSingle();

            if(error || !data) {
                return showMsg("账号或密码错误");
            }

            let loginUser = { ...data };

            // 2. 如果填写了管理员秘钥，进行后端比对
            if(inputSecret) {
                const { data: config } = await _supabase
                    .from('system_config')
                    .select('config_value')
                    .eq('config_key', 'admin_secret_key')
                    .maybeSingle();

                // 秘钥匹配成功
                if(config && inputSecret === config.config_value) {
                    // 动态更新身份（这样 index 页面就会识别你是 Admin）
                    loginUser.username = "Chen_Mj_Admin"; 
                    loginUser.role = "admin";
                    showMsg("管理员身份验证成功...", true);
                } else {
                    return showMsg("管理员秘钥错误");
                }
            }

            // 存储并跳转
            localStorage.setItem('lab_user', JSON.stringify(loginUser));
            setTimeout(() => {
                location.href = 'index.html';
            }, 800);
        }
    </script>
</body>
</html>