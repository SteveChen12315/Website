<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>找回密码 | PRO-LAB</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #00d2ff; --bg: #0a0a0a; --card: #151515; --border: #333; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .find-card { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid var(--border); width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: var(--primary); text-align: center; margin-bottom: 25px; font-size: 1.2rem; }
        .step { display: none; }
        .step.active { display: block; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group i { position: absolute; left: 12px; top: 12px; color: #555; }
        input { width: 100%; padding: 10px 10px 10px 35px; background: #000; border: 1px solid var(--border); color: #fff; border-radius: 6px; outline: none; }
        .btn-action { width: 100%; padding: 12px; background: var(--primary); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .q-text { color: var(--primary); font-size: 0.9rem; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

<div class="find-card">
    <h2>找回您的密码</h2>

    <div id="step1" class="step active">
        <div class="input-group">
            <i class="fas fa-user"></i>
            <input type="text" id="find_user" placeholder="请输入用户名">
        </div>
        <div class="input-group">
            <i class="fas fa-envelope"></i>
            <input type="email" id="find_email" placeholder="注册时的邮箱">
        </div>
        <button class="btn-action" onclick="verifyIdentity()">下一步：验证密保</button>
    </div>

    <div id="step2" class="step">
        <span class="q-text" id="displayQuestion">密保问题加载中...</span>
        <div class="input-group">
            <i class="fas fa-shield-alt"></i>
            <input type="text" id="find_answer" placeholder="请输入密保答案">
        </div>
        <button class="btn-action" onclick="verifyAnswer()">下一步：重置密码</button>
    </div>

    <div id="step3" class="step">
        <div class="input-group">
            <i class="fas fa-lock"></i>
            <input type="password" id="new_pass" placeholder="输入新密码">
        </div>
        <div class="input-group">
            <i class="fas fa-redo"></i>
            <input type="password" id="confirm_pass" placeholder="确认新密码">
        </div>
        <button class="btn-action" onclick="resetPassword()">立即重置并登录</button>
    </div>

    <p style="text-align:center; font-size:12px; margin-top:20px;">
        <a href="login.html" style="color:#666; text-decoration:none;">返回登录页面</a>
    </p>
</div>

<script>
    const SB_URL = 'https://bwbmnaobukcjatwevcqm.supabase.co';
    const SB_KEY = 'sb_publishable_2Pt8kRnWJCI17rA7CGgjyA_lsIhFE4T';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let targetUser = null;

    // 复用登录页的哈希函数
    async function hashPassword(password) {
        const msgUint8 = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // 1. 验证用户名和邮箱是否匹配
    async function verifyIdentity() {
        const user = document.getElementById('find_user').value.trim();
        const email = document.getElementById('find_email').value.trim();

        const { data, error } = await _supabase
            .from('users')
            .select('*')
            .eq('username', user)
            .eq('email', email)
            .maybeSingle();

        if (error || !data) {
            alert("用户名或邮箱错误，无法找回");
        } else {
            targetUser = data;
            document.getElementById('displayQuestion').innerText = "密保问题：" + (data.security_question || "未设置问题");
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }
    }

    // 2. 验证密保答案
    function verifyAnswer() {
        const ans = document.getElementById('find_answer').value.trim();
        if (ans === targetUser.security_answer) {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
        } else {
            alert("密保答案错误！");
        }
    }

    // 3. 执行重置
    async function resetPassword() {
        const p1 = document.getElementById('new_pass').value;
        const p2 = document.getElementById('confirm_pass').value;

        if (p1.length < 6) return alert("新密码至少6位");
        if (p1 !== p2) return alert("两次输入不一致");

        const hashed = await hashPassword(p1);

        const { error } = await _supabase
            .from('users')
            .update({ password_hash: hashed })
            .eq('id', targetUser.id);

        if (error) {
            alert("更新失败: " + error.message);
        } else {
            alert("密码重置成功！请重新登录");
            window.location.href = 'login.html';
        }
    }
</script>
</body>
</html>